<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Speed Controller</title>
    <style>
        body {
            text-align: center;
        }
        .controls {
            margin: 20px;
        }
        #speedControl {
            width: 400px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }
        #speedControl::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #000;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #seekBar {
            width: 200px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }
        #seekBar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #000;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>Audio Speed Controller</h1>
    <audio id="audio1" src="./songs-of-the-wind-on-a-southern-shore-and-other-poems-of-florida-003-song-of-the-wind-on-a-southern-shore.4377.mp3"></audio>
    <audio id="audio2" src="./songs-of-the-wind-on-a-southern-shore-and-other-poems-of-florida-003-song-of-the-wind-on-a-southern-shore.4377.mp3"></audio>
    
    <div>
        <p>Position: <span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>
        <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1">
    </div>
    
    <p>Speed: <span id="speedValue">1.0</span>x</p>
    
    <input type="range" id="speedControl" min="-4.0" max="2.0" step="0.01" value="1.0">
    
    <br><br>
    <button id="playButton">Play / Pause</button>

    <div class="controls">
        <label>Segment Duration (s): <input type="number" id="chunkLength" value="1" step="0.1" min="0.1"></label><br>
        <label>Step (how far back to jump) (s): <input type="number" id="jumpSize" value="0.5" step="0.1" min="0.1"></label><br>
        <label>Period (how often to jump) (ms): <input type="number" id="updateInterval" value="500" step="50" min="250"></label><br>
        <label>Reverse Playback Speed: <input type="number" id="reversePlaybackSpeed" value="1.0" step="0.1" min="0.1" max="2.0" readonly></label>
    </div>

    <script>
        const audio1 = document.getElementById("audio1");
        const audio2 = document.getElementById("audio2");
        const speedSlider = document.getElementById("speedControl");
        const speedValue = document.getElementById("speedValue");
        const playButton = document.getElementById("playButton");
        const chunkLengthInput = document.getElementById("chunkLength");
        const jumpSizeInput = document.getElementById("jumpSize");
        const updateIntervalInput = document.getElementById("updateInterval");
        const reversePlaybackSpeedInput = document.getElementById("reversePlaybackSpeed");
        const seekBar = document.getElementById("seekBar");
        const currentTimeDisplay = document.getElementById("currentTime");
        const durationDisplay = document.getElementById("duration");

        let audioContext;
        let source1, source2;
        let gainNode1, gainNode2;
        let initialized = false;
        let intervalId = null;
        let currentSpeed = 1.0;
        let isPlaying = false;
        let currentPosition = 0;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        audio1.addEventListener("loadedmetadata", () => {
            seekBar.max = audio1.duration;
            durationDisplay.textContent = formatTime(audio1.duration);
        });

        setInterval(() => {
            if (isPlaying) {
                currentTimeDisplay.textContent = formatTime(currentPosition);
                seekBar.value = currentPosition;
            }
        }, 100);

        seekBar.addEventListener("input", () => {
            currentPosition = parseFloat(seekBar.value);
            currentTimeDisplay.textContent = formatTime(currentPosition);
            if (currentSpeed >= 0) {
                audio1.currentTime = currentPosition;
                audio2.currentTime = currentPosition;
            }
        });

        function initAudioContext() {
            if (!initialized) {
                audioContext = new AudioContext();
                source1 = audioContext.createMediaElementSource(audio1);
                source2 = audioContext.createMediaElementSource(audio2);
                
                gainNode1 = audioContext.createGain();
                gainNode2 = audioContext.createGain();
                
                source1.connect(gainNode1);
                source2.connect(gainNode2);
                gainNode1.connect(audioContext.destination);
                gainNode2.connect(audioContext.destination);
                
                gainNode1.gain.value = 1.0;
                gainNode2.gain.value = 1.0;
                
                initialized = true;
            }
        }

        function startBackwardPlayback() {
            if (intervalId) clearInterval(intervalId);
            
            const updateInterval = parseInt(updateIntervalInput.value);
            const chunkLength = parseFloat(chunkLengthInput.value);
            const jumpSize = parseFloat(jumpSizeInput.value);
            const calculatedSpeed = (chunkLength * 1000) / updateInterval;
            const playbackSpeed = Math.max(0.1, Math.min(2.0, calculatedSpeed));
            
            let useAudio1 = true;
            let timeout1 = null;
            let timeout2 = null;

            window.backwardTimeout1 = null;
            window.backwardTimeout2 = null;

            audio1.currentTime = currentPosition;
            audio1.playbackRate = playbackSpeed;
            audio1.play();
            gainNode1.gain.value = 1.0;
            gainNode2.gain.value = 0;
            
            timeout1 = setTimeout(() => {
                audio1.pause();
            }, (chunkLength * 1000) / playbackSpeed);
            window.backwardTimeout1 = timeout1;
            
            intervalId = setInterval(() => {
                if (!isPlaying) return;
                
                currentPosition = Math.max(0, currentPosition - jumpSize);
             
                const activeAudio = useAudio1 ? audio2 : audio1;
                const activeGain = useAudio1 ? gainNode2 : gainNode1;
                const otherGain = useAudio1 ? gainNode1 : gainNode2;
                const otherAudio = useAudio1 ? audio1 : audio2;

                const now = audioContext.currentTime;
                const fadeTime = 0.2; 
                const chunkDuration = (chunkLength * 1000) / playbackSpeed / 1000; 

                activeGain.gain.cancelScheduledValues(now);
                activeGain.gain.setValueAtTime(0, now);
                activeGain.gain.linearRampToValueAtTime(1.0, now + fadeTime);
                activeGain.gain.setValueAtTime(1.0, now + chunkDuration - fadeTime);
                activeGain.gain.linearRampToValueAtTime(0, now + chunkDuration); 

                activeAudio.currentTime = currentPosition;
                activeAudio.playbackRate = playbackSpeed;
                activeAudio.play();

                setTimeout(() => {
                    otherAudio.pause();
                }, fadeTime * 1000);

                useAudio1 = !useAudio1;
                
                if (currentPosition <= 0) {
                    stopPlayback();
                }
            }, updateInterval);
        }

        function stopBackwardPlayback() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (window.backwardTimeout1) {
                clearTimeout(window.backwardTimeout1);
                window.backwardTimeout1 = null;
            }
            if (window.backwardTimeout2) {
                clearTimeout(window.backwardTimeout2);
                window.backwardTimeout2 = null;
            }
            audio1.pause();
            audio2.pause();
        }

        function startForwardPlayback() {
            stopBackwardPlayback();

            gainNode1.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode2.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode1.gain.value = 1.0;
            gainNode2.gain.value = 0;

            audio2.pause();
            audio2.currentTime = 0;

            audio1.currentTime = currentPosition;
            audio1.playbackRate = Math.max(0.0625, currentSpeed);

            const playPromise = audio1.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Play failed:", error);
                });
            }

            const updatePos = setInterval(() => {
                if (!isPlaying || currentSpeed < 0) {
                    clearInterval(updatePos);
                    return;
                }
                currentPosition = audio1.currentTime;
            }, 100);
        }

        function stopPlayback() {
            isPlaying = false;
            stopBackwardPlayback();
            audio1.pause();
            audio2.pause();
        }

        playButton.addEventListener("click", () => {
            initAudioContext();
            
            if (isPlaying) {
                stopPlayback();
            } else {
                isPlaying = true;
                if (currentSpeed < 0) {
                    startBackwardPlayback();
                } else {
                    startForwardPlayback();
                }
            }
        });

        let speedChangeTimeout;
        let wasNegative = false;
        
        speedSlider.addEventListener("input", () => {
            const prevSpeed = currentSpeed;
            const prevWasNegative = wasNegative;
            currentSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = currentSpeed.toFixed(2);
            
            const isNegativeNow = currentSpeed < -0.1;
            const crossedZero = (prevSpeed >= 0 && currentSpeed < 0) || (prevSpeed < 0 && currentSpeed >= 0);

            if (isNegativeNow) {
                const absSpeed = Math.abs(currentSpeed);
                jumpSizeInput.value = absSpeed.toFixed(2);
                chunkLengthInput.value = 1.0;
                updateIntervalInput.value = (1000 / absSpeed).toFixed(0);
                const calculatedSpeed = (1.0 * 1000) / (1000 / absSpeed);
                reversePlaybackSpeedInput.value = calculatedSpeed.toFixed(2);
            }

            if (isPlaying && crossedZero) {
                clearTimeout(speedChangeTimeout);
                wasNegative = currentSpeed < 0;
                
                if (currentSpeed >= 0) {
                    startForwardPlayback();
                } else {
                    currentPosition = audio1.currentTime;
                    startBackwardPlayback();
                }
                return;
            }

            clearTimeout(speedChangeTimeout);
            speedChangeTimeout = setTimeout(() => {
                if (isPlaying) {
                    if (currentSpeed < 0) {
                        startBackwardPlayback();
                    }
                }
                wasNegative = currentSpeed < 0;
            }, 300);

            if (isPlaying && currentSpeed >= 0) {
                audio1.playbackRate = Math.max(0.0625, currentSpeed);
            }
        });

        audio1.addEventListener("ended", () => {
            if (currentSpeed >= 0) {
                stopPlayback();
            }
        });

        reversePlaybackSpeedInput.addEventListener("input", () => {
            if (isPlaying && currentSpeed < 0) {
                startBackwardPlayback();
            }
        });
    </script>
</body>
</html>