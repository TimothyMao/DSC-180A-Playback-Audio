<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Speed Controller</title>
    <style>
        body {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Audio Speed Controller</h1>
    <button id="playButton" disabled>Play</button>
    
    <div class="speed-controls">
        <label for="speedSlider">Playback Speed: <span id="speedValue">1.0</span>x</label><br>
        <input type="range" id="speedSlider" min="0.5" max="2" step="0.01" value="1">
    </div>

    <script>
        let audioContext;
        let audioBuffer;
        let isPlaying = false;
        let currentTime = 0;
        let playbackRate = 1.0;
        
        const grainSize = 0.08;
        const overlap = 0.25;

        const playButton = document.getElementById("playButton");
        const speedSlider = document.getElementById("speedSlider");
        const speedValue = document.getElementById("speedValue");

        async function loadAudio() {
            try {
                audioContext = new AudioContext();
                const response = await fetch('./counting-and-math-rhymes-043-the-twelve-days-of-christmas.4992.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                playButton.disabled = false;
            } catch (error) {
                console.error('Error loading audio:', error);
            }
        }

        function playGrain() {
            if (!isPlaying || currentTime >= audioBuffer.duration) {
                if (currentTime >= audioBuffer.duration) {
                    stop();
                }
                return;
            }

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            
            const gainNode = audioContext.createGain();
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            const now = audioContext.currentTime;
            const fadeTime = grainSize * 0.1;
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(1, now + fadeTime);
            gainNode.gain.setValueAtTime(1, now + grainSize - fadeTime);
            gainNode.gain.linearRampToValueAtTime(0, now + grainSize);
            
            source.start(now, currentTime, grainSize);
            
            currentTime += grainSize * overlap;
            
            const delay = (grainSize * overlap / playbackRate) * 1000;
            setTimeout(playGrain, delay);
        }

        function play() {
            if (!audioBuffer) return;
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            isPlaying = true;
            playButton.textContent = 'Pause';
            playGrain();
        }

        function pause() {
            isPlaying = false;
            playButton.textContent = 'Play';
        }

        function stop() {
            isPlaying = false;
            currentTime = 0;
            playButton.textContent = 'Play';
        }

        playButton.addEventListener("click", () => {
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        });

        speedSlider.addEventListener("input", (e) => {
            playbackRate = parseFloat(e.target.value);
            speedValue.textContent = playbackRate.toFixed(2);
        });

        loadAudio();
    </script>
</body>
</html>