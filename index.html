<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Speed Controller</title>
    <style>
        body {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Audio Speed Controller</h1>
    <button id="playButton" disabled>Play</button>
    
    <div class="speed-controls">
        <label for="speedSlider">Playback Speed: <span id="speedValue">1.0</span>x</label><br>
        <input type="range" id="speedSlider" min="0.5" max="2" step="0.01" value="1">
    </div>

    <script>
        let audioContext;
        let audioBuffer;
        let sourceNode;
        let isPlaying = false;
        let startTime = 0;
        let pauseTime = 0;
        let playbackRate = 1.0;

        const playButton = document.getElementById("playButton");
        const speedSlider = document.getElementById("speedSlider");
        const speedValue = document.getElementById("speedValue");
        const statusDiv = document.getElementById("status");

        async function loadAudio() {
            try {
                audioContext = new AudioContext();
                
                const response = await fetch('./counting-and-math-rhymes-043-the-twelve-days-of-christmas.4992.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                playButton.disabled = false;
            } catch (error) {
                statusDiv.textContent = 'Error loading audio: ' + error.message;
                console.error('Error loading audio:', error);
            }
        }

        async function play() {
            if (!audioBuffer) return;
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.playbackRate.value = playbackRate;
            sourceNode.connect(audioContext.destination);
            
            sourceNode.onended = () => {
                if (isPlaying) {
                    isPlaying = false;
                    playButton.textContent = 'Play';
                    pauseTime = 0;
                }
            };

            sourceNode.start(0, pauseTime);
            startTime = audioContext.currentTime - pauseTime;
            isPlaying = true;
            playButton.textContent = 'Pause';
            
            console.log('Playing audio at speed:', playbackRate);
            console.log('Audio context state:', audioContext.state);
        }

        function pause() {
            if (sourceNode) {
                pauseTime = audioContext.currentTime - startTime;
                sourceNode.stop();
                sourceNode = null;
            }
            isPlaying = false;
            playButton.textContent = 'Play';
        }

        playButton.addEventListener("click", () => {
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        });

        speedSlider.addEventListener("input", (e) => {
            playbackRate = parseFloat(e.target.value);
            speedValue.textContent = playbackRate.toFixed(2);
            
            if (isPlaying && sourceNode) {
                sourceNode.playbackRate.value = playbackRate;
            }
        });

        loadAudio();
    </script>
</body>
</html>