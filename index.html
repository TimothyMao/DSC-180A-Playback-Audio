<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Speed Controller</title>
    <style>
        body {
            text-align: center;
        }
        .controls {
            margin: 20px;
        }
        #speedControl, #filteredSpeedControl, #seekBar {
            width: 400px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }
        #seekBar { width: 200px; }
        #speedControl::-webkit-slider-thumb,
        #filteredSpeedControl::-webkit-slider-thumb,
        #seekBar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #000;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <h1>Audio Speed Controller</h1>
    <audio id="audio1" src="./songs-of-the-wind-on-a-southern-shore-and-other-poems-of-florida-003-song-of-the-wind-on-a-southern-shore.4377.mp3"></audio>
    <audio id="audio2" src="./songs-of-the-wind-on-a-southern-shore-and-other-poems-of-florida-003-song-of-the-wind-on-a-southern-shore.4377.mp3"></audio>

    <div>
        <p>Position: <span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>
        <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1">
    </div>

    <p>Speed: <span id="speedValue">1.0</span>x</p>
    <input type="range" id="speedControl" min="-4.0" max="2.0" step="0.01" value="1.0">

    <br><br>
    <p>Filtered Speed: <span id="filteredSpeedValue">1.0</span>x</p>
    <input type="range" id="filteredSpeedControl" min="-4.0" max="2.0" step="0.01" value="1.0" disabled>

    <br><br>
    <label>Alpha (how fast the slider follows): <input type="number" id="alphaInput" value="0.01" step="0.01" min="0.01" max="1.0"></label>

    <br><br>
    <button id="playButton">Play / Pause</button>

    <div class="controls">
        <label>Segment Duration (s): <input type="number" id="chunkLength" value="1" step="0.1" min="0.1"></label><br>
        <label>Step (how far back to jump) (s): <input type="number" id="jumpSize" value="0.5" step="0.1" min="0.1"></label><br>
        <label>Period (how often to jump) (ms): <input type="number" id="updateInterval" value="500" step="50" min="50"></label><br>
        <label>Reverse Playback Speed: <input type="number" id="reversePlaybackSpeed" value="1.0" step="0.1" min="0.1" max="2.0"></label>
    </div>

    <script>
        const audio1 = document.getElementById("audio1");
        const audio2 = document.getElementById("audio2");
        const speedSlider = document.getElementById("speedControl");
        const speedValue = document.getElementById("speedValue");
        const filteredSpeedSlider = document.getElementById("filteredSpeedControl");
        const filteredSpeedValue = document.getElementById("filteredSpeedValue");
        const alphaInput = document.getElementById("alphaInput");
        const playButton = document.getElementById("playButton");
        const chunkLengthInput = document.getElementById("chunkLength");
        const jumpSizeInput = document.getElementById("jumpSize");
        const updateIntervalInput = document.getElementById("updateInterval");
        const reversePlaybackSpeedInput = document.getElementById("reversePlaybackSpeed");
        const seekBar = document.getElementById("seekBar");
        const currentTimeDisplay = document.getElementById("currentTime");
        const durationDisplay = document.getElementById("duration");

        let audioContext;
        let source1, source2;
        let gainNode1, gainNode2;
        let initialized = false;
        let intervalId = null;
        let currentSpeed = 1.0;
        let filteredSpeed = 1.0;
        let isPlaying = false;
        let currentPosition = 0;
        let filterAnimationId = null;
        let wasNegative = false;
        let speedChangeTimeout;
        let positionUpdateInterval = null;
        let lastFilteredSpeed = 1.0;
        let speedChangeRate = 0;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateFilteredSpeed() {
            const alpha = parseFloat(alphaInput.value);
            const targetSpeed = currentSpeed;
            const prevFilteredSpeed = filteredSpeed;
            filteredSpeed = filteredSpeed - alpha * (filteredSpeed - targetSpeed);
            filteredSpeedValue.textContent = filteredSpeed.toFixed(2);
            filteredSpeedSlider.value = filteredSpeed;

            speedChangeRate = Math.abs(filteredSpeed - lastFilteredSpeed);
            lastFilteredSpeed = filteredSpeed;

            const crossedZero = (prevFilteredSpeed >= 0 && filteredSpeed < 0) || (prevFilteredSpeed < 0 && filteredSpeed >= 0);

            if (isPlaying && crossedZero) {
                clearTimeout(speedChangeTimeout);
                wasNegative = filteredSpeed < 0;

                if (filteredSpeed >= 0) {
                    startForwardPlayback();
                } else {
                    currentPosition = audio1.currentTime || currentPosition;
                    const absSpeed = Math.abs(filteredSpeed);
                    jumpSizeInput.value = 1.0;
                    updateIntervalInput.value = (1000 / absSpeed).toFixed(0);
                    startBackwardPlayback();
                }
            } else if (isPlaying && filteredSpeed < 0) {
                const absSpeed = Math.abs(filteredSpeed);
                jumpSizeInput.value = 1.0;
                updateIntervalInput.value = (1000 / absSpeed).toFixed(0);
                
                if (speedChangeRate < 0.05 && intervalId) {
                    clearTimeout(speedChangeTimeout);
                    speedChangeTimeout = setTimeout(() => {
                        if (isPlaying && filteredSpeed < 0) {
                            startBackwardPlayback();
                        }
                        wasNegative = filteredSpeed < 0;
                    }, 20);
                } else if (!intervalId) {
                    startBackwardPlayback();
                }
            } else if (isPlaying && filteredSpeed >= 0) {
                audio1.playbackRate = Math.max(0.0625, filteredSpeed);
            }

            const diff = Math.abs(filteredSpeed - targetSpeed);
            if (diff > 0.001) {
                filterAnimationId = requestAnimationFrame(updateFilteredSpeed);
            } else {
                filteredSpeed = targetSpeed;
                filteredSpeedValue.textContent = filteredSpeed.toFixed(2);
                filteredSpeedSlider.value = filteredSpeed;
                filterAnimationId = null;
            }
        }

        audio1.addEventListener("loadedmetadata", () => {
            seekBar.max = audio1.duration;
            durationDisplay.textContent = formatTime(audio1.duration);
        });

        setInterval(() => {
            if (isPlaying) {
                currentTimeDisplay.textContent = formatTime(currentPosition);
                seekBar.value = currentPosition;
            }
        }, 100);

        seekBar.addEventListener("input", () => {
            currentPosition = parseFloat(seekBar.value);
            currentTimeDisplay.textContent = formatTime(currentPosition);
            if (filteredSpeed >= 0) {
                audio1.currentTime = currentPosition;
                audio2.currentTime = currentPosition;
            }
        });

        function initAudioContext() {
            if (!initialized) {
                audioContext = new AudioContext();
                source1 = audioContext.createMediaElementSource(audio1);
                source2 = audioContext.createMediaElementSource(audio2);
                gainNode1 = audioContext.createGain();
                gainNode2 = audioContext.createGain();
                source1.connect(gainNode1);
                source2.connect(gainNode2);
                gainNode1.connect(audioContext.destination);
                gainNode2.connect(audioContext.destination);
                gainNode1.gain.value = 1.0;
                gainNode2.gain.value = 1.0;
                initialized = true;
            }
        }

        function startBackwardPlayback() {
            if (intervalId) clearInterval(intervalId);

            const updateInterval = parseInt(updateIntervalInput.value);
            const chunkLength = parseFloat(chunkLengthInput.value);
            const jumpSize = parseFloat(jumpSizeInput.value);
            const playbackSpeed = parseFloat(reversePlaybackSpeedInput.value);
            const windowDuration = 0.02;

            let useAudio1 = true;
            let timeout1 = null;
            let timeout2 = null;

            window.backwardTimeout1 = null;
            window.backwardTimeout2 = null;

            audio1.currentTime = currentPosition;
            audio1.playbackRate = playbackSpeed;
            gainNode1.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode1.gain.linearRampToValueAtTime(1.0, audioContext.currentTime + windowDuration);
            audio1.play();
            gainNode2.gain.value = 0;

            timeout1 = setTimeout(() => {
                gainNode1.gain.setValueAtTime(1.0, audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0, audioContext.currentTime + windowDuration);
                setTimeout(() => audio1.pause(), windowDuration * 1000);
            }, (chunkLength - windowDuration) * 1000);
            window.backwardTimeout1 = timeout1;

            intervalId = setInterval(() => {
                if (!isPlaying) return;

                currentPosition = Math.max(0, currentPosition - jumpSize);

                const activeAudio = useAudio1 ? audio2 : audio1;
                const activeGain = useAudio1 ? gainNode2 : gainNode1;
                const otherGain = useAudio1 ? gainNode1 : gainNode2;
                const activeTimeout = useAudio1 ? timeout2 : timeout1;

                if (activeTimeout) clearTimeout(activeTimeout);

                activeGain.gain.setValueAtTime(0, audioContext.currentTime);
                activeGain.gain.linearRampToValueAtTime(1.0, audioContext.currentTime + windowDuration);

                activeAudio.currentTime = currentPosition;
                activeAudio.playbackRate = playbackSpeed;
                activeAudio.play();

                const newTimeout = setTimeout(() => {
                    activeGain.gain.setValueAtTime(1.0, audioContext.currentTime);
                    activeGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + windowDuration);
                    setTimeout(() => activeAudio.pause(), windowDuration * 1000);
                }, (chunkLength - windowDuration) * 1000);

                if (useAudio1) {
                    timeout2 = newTimeout;
                    window.backwardTimeout2 = newTimeout;
                } else {
                    timeout1 = newTimeout;
                    window.backwardTimeout1 = newTimeout;
                }

                useAudio1 = !useAudio1;

                if (currentPosition <= 0) {
                    stopPlayback();
                }
            }, updateInterval);
        }

        function stopBackwardPlayback() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (window.backwardTimeout1) {
                clearTimeout(window.backwardTimeout1);
                window.backwardTimeout1 = null;
            }
            if (window.backwardTimeout2) {
                clearTimeout(window.backwardTimeout2);
                window.backwardTimeout2 = null;
            }
            audio1.pause();
            audio2.pause();
        }

        function startForwardPlayback() {
            stopBackwardPlayback();
            if (positionUpdateInterval) {
                clearInterval(positionUpdateInterval);
            }

            gainNode1.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode2.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode1.gain.value = 1.0;
            gainNode2.gain.value = 0;

            audio2.pause();
            audio2.currentTime = 0;

            audio1.currentTime = currentPosition;
            audio1.playbackRate = Math.max(0.0625, filteredSpeed);
            audio1.play();

            positionUpdateInterval = setInterval(() => {
                if (!isPlaying || filteredSpeed < 0) {
                    clearInterval(positionUpdateInterval);
                    positionUpdateInterval = null;
                    return;
                }
                currentPosition = audio1.currentTime;
            }, 100);
        }

        function stopPlayback() {
            isPlaying = false;
            stopBackwardPlayback();
            if (positionUpdateInterval) {
                clearInterval(positionUpdateInterval);
                positionUpdateInterval = null;
            }
            audio1.pause();
            audio2.pause();
        }

        playButton.addEventListener("click", () => {
            initAudioContext();

            if (isPlaying) {
                stopPlayback();
            } else {
                isPlaying = true;
                if (filteredSpeed < 0) {
                    startBackwardPlayback();
                } else {
                    startForwardPlayback();
                }
            }
        });

        speedSlider.addEventListener("input", () => {
            currentSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = currentSpeed.toFixed(2);
            if (filterAnimationId) {
                cancelAnimationFrame(filterAnimationId);
            }
            updateFilteredSpeed();
        });

        audio1.addEventListener("ended", () => {
            if (filteredSpeed >= 0) {
                stopPlayback();
            }
        });

        reversePlaybackSpeedInput.addEventListener("input", () => {
            if (isPlaying && filteredSpeed < 0) {
                startBackwardPlayback();
            }
        });
    </script>
</body>
</html>